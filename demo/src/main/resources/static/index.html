<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Delivery</title>
</head>
<body>

<h2>API Delivery</h2>

<!-- ✅ Add API Delivery Form -->
<h3>Add API Delivery</h3>
<form onsubmit="return addApiHistory(event);">
    <label for="addMicroserviceName">Microservice Name:</label>
    <input type="text" id="addMicroserviceName" required>

    <label for="addApiName">API Name:</label>
    <input type="text" id="addApiName" required>

    <label for="addApiStatus">API Status:</label>
    <input type="text" id="addApiStatus" required>

    <label for="iterationCount">Iteration Count:</label>
    <input type="number" id="iterationCount" required>

    <label for="addDeliveryDate">Delivery Date:</label>
    <input type="date" id="addDeliveryDate" required>

    <label for="addPlannedEndDate">Planned End Date:</label>
    <input type="date" id="addPlannedEndDate" required>

    <label for="addStatus">Actual End Date Status:</label>
    <input type="text" id="addStatus" required>

    <label for="addTesterName">Tester:</label>
    <input type="text" id="addTesterName" required>

    <button type="submit">Add API Delivery</button>
</form>

<hr>

<!-- ✅ Fetch API History Section -->
<h3>Fetch API Delivery</h3>
<label for="microserviceName">Microservice Name:</label>
<input type="text" id="microserviceName">
<label for="apiName">API Name:</label>
<input type="text" id="apiName">
<button onclick="fetchApiHistory()">Fetch Deliveries</button>

<h3>Current Deliveries</h3>
<table border="1">
    <thead>
    <tr>
        <th>MS Name</th>
        <th>API Name</th>
        <th>API Status</th>
        <th>Iteration Count</th>
        <th>Delivery Date</th>
        <th>Planned End Date</th>
        <th>Actual End Date Status</th>
        <th>Tester</th>
    </tr>
    </thead>
    <tbody id="currentDeliveryTable"></tbody>
</table>

<h3>Previous Deliveries</h3>
<table border="1">
    <thead>
    <tr>
        <th>MS Name</th>
        <th>API Name</th>
        <th>API Status</th>
        <th>Iteration Count</th>
        <th>Delivery Date</th>
        <th>Planned End Date</th>
        <th>Actual End Date Status</th>
        <th>Tester</th>
    </tr>
    </thead>
    <tbody id="previousDeliveriesTable"></tbody>
</table>

<script>
    // ✅ Function to Add API History
    function addApiHistory(event) {
        event.preventDefault(); // Prevents form refresh

        let data = {
            microserviceName: document.getElementById("addMicroserviceName").value.trim(),
            apiName: document.getElementById("addApiName").value.trim(),
            apiStatus: document.getElementById("addApiStatus").value.trim(),
            iterationCount: parseInt(document.getElementById("iterationCount").value) || 0,
            deliveryDate: document.getElementById("addDeliveryDate").value,
            plannedEndDate: document.getElementById("addPlannedEndDate").value,
            status: document.getElementById("addStatus").value.trim(),
            testerName: document.getElementById("addTesterName").value.trim()
        };

        // ✅ Ensure all fields are filled
        if (Object.values(data).some(value => value === "")) {
            alert("All fields are required!");
            return;
        }

        fetch("/api-history/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                alert("API Delivery added successfully!");
                document.querySelector("form").reset(); // Clear form fields
                fetchApiHistory(); // Refresh the table
            })
            .catch(error => {
                console.error("Error adding API history:", error);
                alert("Failed to add API delivery.");
            });
    }

    // ✅ Function to Fetch API History
    function fetchApiHistory() {
        let microserviceName = document.getElementById("microserviceName").value.trim();
        let apiName = document.getElementById("apiName").value.trim();

        fetch(`/api-history/fetch?microserviceName=${microserviceName}&apiName=${apiName}`)
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message); // No records found
                    return;
                }

                // ✅ Display Current Deliveries
                let currentDeliveryTable = document.getElementById("currentDeliveryTable");
                currentDeliveryTable.innerHTML = "";

                if (data.currentDelivery) {
                    let c = data.currentDelivery;
                    currentDeliveryTable.innerHTML += `
                    <tr>
                        <td>${c.microserviceName}</td>
                        <td>${c.apiName}</td>
                        <td>${c.apiStatus}</td>
                        <td>${c.iterationCount}</td>
                        <td>${c.deliveryDate}</td>
                        <td>${c.plannedEndDate}</td>
                        <td>${c.status}</td>
                        <td>${c.testerName}</td>
                    </tr>`;
                }

                // ✅ Display Previous Deliveries
                let previousDeliveriesTable = document.getElementById("previousDeliveriesTable");
                previousDeliveriesTable.innerHTML = "";
                data.previousDeliveries.forEach(entry => {
                    previousDeliveriesTable.innerHTML += `
                    <tr>
                        <td>${entry.microserviceName}</td>
                        <td>${entry.apiName}</td>
                        <td>${entry.apiStatus}</td>
                        <td>${entry.iterationCount}</td>
                        <td>${entry.deliveryDate}</td>
                        <td>${entry.plannedEndDate}</td>
                        <td>${entry.status}</td>
                        <td>${entry.testerName}</td>
                    </tr>`;
                });
            })
            .catch(error => {
                console.error("Error fetching API history:", error);
                alert("Failed to fetch API deliveries.");
            });
    }
</script>

</body>
</html>
